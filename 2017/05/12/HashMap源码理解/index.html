<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Ben Wong,wenbinben@gmail.com"><title>HashMap源码理解 · 杏仁的博客</title><meta name="description" content="Java版本：java version “1.8.0_131”
调用putVal插入值的时候，若链表中节点超过TREEIFY_THRESHOLD，则调用treeifyBin函数，若桶个数少于64，则resize;否则由链表转成红黑树。插入值的时候，若元素个数超过threshold，也会调用resiz"><meta name="keywords" content="Hexo,HTML,Ben,CSS,安卓,android,Linux,linuxdeepin"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">杏仁的博客</a></h3><div class="description"><p>Nothing lasts forever.</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/Ben_wenbin"><i class="fa fa-twitter"></i></a></li><li><a href="http://instagram.com/hwbinbenben"><i class="fa fa-instagram"></i></a></li><li><a href="/atom.xml"><i class="fa fa-rss"></i></a></li><li><a href="http://weibo.com/ben0036"><i class="fa fa-weibo"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai</a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="https://secure.gravatar.com/avatar/e71df8021446fe9759a9928b1dd5c28d?s=180&amp;r=G&amp;d="></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>HashMap源码理解</a></h3></div><div class="post-content"><p>Java版本：java version “1.8.0_131”</p>
<p>调用putVal插入值的时候，若链表中节点超过TREEIFY_THRESHOLD，则调用treeifyBin函数，若桶个数少于64，则resize;否则由链表转成红黑树。<br>插入值的时候，若元素个数超过threshold，也会调用resize函数。<br>在resize，桶个数double的时候，将链表分为两部分.或者调用红黑树的split函数，将<br>红黑树分成两部分，此时，若红黑树中的节点个数小于某个值，则由红黑树改成原来的链表。</p>
<h2 id="HashMap的变量"><a href="#HashMap的变量" class="headerlink" title="HashMap的变量"></a>HashMap的变量</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">362498820763181265L</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">4</span>; <span class="comment">// aka 16</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> DEFAULT_LOAD_FACTOR = <span class="number">0.75f</span>;</div><div class="line"><span class="comment">//大于此值，调用treeifyBin函数。由链表转成红黑树或者resize</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEIFY_THRESHOLD = <span class="number">8</span>;</div><div class="line"><span class="comment">//小于此值，由红黑树转成链表</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UNTREEIFY_THRESHOLD = <span class="number">6</span>;</div><div class="line"><span class="comment">//当一条链上的节点太多时，会调用treeifyBin函数，若table小于此值，则resize;否则转成红黑树</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MIN_TREEIFY_CAPACITY = <span class="number">64</span>;</div><div class="line"></div><div class="line"><span class="keyword">transient</span> Node&lt;K,V&gt;[] table;</div><div class="line"><span class="keyword">transient</span> Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet;</div><div class="line"><span class="keyword">transient</span> <span class="keyword">int</span> size;<span class="comment">//元素个数</span></div><div class="line"><span class="keyword">transient</span> <span class="keyword">int</span> modCount;<span class="comment">//修改次数</span></div><div class="line"><span class="keyword">int</span> threshold;<span class="comment">//元素个数大于此值，会调用resize</span></div><div class="line"><span class="keyword">final</span> <span class="keyword">float</span> loadFactor;</div></pre></td></tr></table></figure>
<h2 id="Node节点定义如下"><a href="#Node节点定义如下" class="headerlink" title="Node节点定义如下"></a>Node节点定义如下</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> hash;</div><div class="line">   <span class="keyword">final</span> K key;</div><div class="line">   V value;</div><div class="line">   Node&lt;K,V&gt; next;</div><div class="line"></div><div class="line">   Node(<span class="keyword">int</span> hash, K key, V value, Node&lt;K,V&gt; next) &#123;</div><div class="line">       <span class="keyword">this</span>.hash = hash;</div><div class="line">       <span class="keyword">this</span>.key = key;</div><div class="line">       <span class="keyword">this</span>.value = value;</div><div class="line">       <span class="keyword">this</span>.next = next;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> K <span class="title">getKey</span><span class="params">()</span>        </span>&#123; <span class="keyword">return</span> key; &#125;</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">getValue</span><span class="params">()</span>      </span>&#123; <span class="keyword">return</span> value; &#125;</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> key + <span class="string">"="</span> + value; &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> Objects.hashCode(key) ^ Objects.hashCode(value);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">setValue</span><span class="params">(V newValue)</span> </span>&#123;</div><div class="line">       V oldValue = value;</div><div class="line">       value = newValue;</div><div class="line">       <span class="keyword">return</span> oldValue;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (o == <span class="keyword">this</span>)</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       <span class="keyword">if</span> (o <span class="keyword">instanceof</span> Map.Entry) &#123;</div><div class="line">           Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;)o;</div><div class="line">           <span class="keyword">if</span> (Objects.equals(key, e.getKey()) &amp;&amp;</div><div class="line">               Objects.equals(value, e.getValue()))</div><div class="line">               <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="HashMap实现"><a href="#HashMap实现" class="headerlink" title="HashMap实现"></a>HashMap实现</h2><p>HashMap桶大小总是2的幂，当用初始变量初始化HashMap时，会调用如下函数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* Returns a power of two size for the given target capacity.</div><div class="line">*/</div><div class="line"><span class="comment">//3(4),8(8),21(32)</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tableSizeFor</span><span class="params">(<span class="keyword">int</span> cap)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> n = cap - <span class="number">1</span>;</div><div class="line">   n |= n &gt;&gt;&gt; <span class="number">1</span>;</div><div class="line">   n |= n &gt;&gt;&gt; <span class="number">2</span>;</div><div class="line">   n |= n &gt;&gt;&gt; <span class="number">4</span>;</div><div class="line">   n |= n &gt;&gt;&gt; <span class="number">8</span>;</div><div class="line">   n |= n &gt;&gt;&gt; <span class="number">16</span>;</div><div class="line">   <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="HashMap获取元素"><a href="#HashMap获取元素" class="headerlink" title="HashMap获取元素"></a>HashMap获取元素</h3><p>根据key,获取map中的元素<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">   Node&lt;K,V&gt; e;</div><div class="line">   <span class="keyword">return</span> (e = getNode(hash(key), key)) == <span class="keyword">null</span> ? <span class="keyword">null</span> : e.value;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//在map中查找元素(会查找链表或者红黑树)</span></div><div class="line"><span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">getNode</span><span class="params">(<span class="keyword">int</span> hash, Object key)</span> </span>&#123;</div><div class="line">   Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; <span class="keyword">int</span> n; K k;</div><div class="line">   <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</div><div class="line">       (first = tab[(n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">if</span> (first.hash == hash &amp;&amp; <span class="comment">// always check first node</span></div><div class="line">           ((k = first.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</div><div class="line">           <span class="keyword">return</span> first;</div><div class="line">       <span class="keyword">if</span> ((e = first.next) != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode)</div><div class="line">               <span class="keyword">return</span> ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</div><div class="line">           <span class="keyword">do</span> &#123;</div><div class="line">               <span class="keyword">if</span> (e.hash == hash &amp;&amp;</div><div class="line">                   ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</div><div class="line">                   <span class="keyword">return</span> e;</div><div class="line">           &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>getTreeNode源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* Finds the node starting at root p with the given hash and key.</div><div class="line">* The kc argument caches comparableClassFor(key) upon first use</div><div class="line">* comparing keys.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">final</span> TreeNode&lt;K,V&gt; <span class="title">find</span><span class="params">(<span class="keyword">int</span> h, Object k, Class&lt;?&gt; kc)</span> </span>&#123;</div><div class="line">  TreeNode&lt;K,V&gt; p = <span class="keyword">this</span>;</div><div class="line">  <span class="keyword">do</span> &#123;</div><div class="line">      <span class="keyword">int</span> ph, dir; K pk;</div><div class="line">      TreeNode&lt;K,V&gt; pl = p.left, pr = p.right, q;</div><div class="line">      <span class="keyword">if</span> ((ph = p.hash) &gt; h)<span class="comment">//左边</span></div><div class="line">          p = pl;</div><div class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)<span class="comment">//右边</span></div><div class="line">          p = pr;</div><div class="line">      <span class="comment">//hash值相等，并且key相等</span></div><div class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ((pk = p.key) == k || (k != <span class="keyword">null</span> &amp;&amp; k.equals(pk)))</div><div class="line">          <span class="keyword">return</span> p;</div><div class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (pl == <span class="keyword">null</span>)</div><div class="line">          p = pr;</div><div class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (pr == <span class="keyword">null</span>)</div><div class="line">          p = pl;</div><div class="line">      <span class="comment">//hash值相等，并且(pk为null,两者Class不相等，两者key相等）时返回0</span></div><div class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ((kc != <span class="keyword">null</span> ||</div><div class="line">                (kc = comparableClassFor(k)) != <span class="keyword">null</span>) &amp;&amp;</div><div class="line">               (dir = compareComparables(kc, k, pk)) != <span class="number">0</span>)</div><div class="line">          p = (dir &lt; <span class="number">0</span>) ? pl : pr;</div><div class="line">      <span class="comment">//hash值相等，k为null，pk为null,两者Class不相等，两者key相等，在右子树上寻找</span></div><div class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ((q = pr.find(h, k, kc)) != <span class="keyword">null</span>)</div><div class="line">          <span class="keyword">return</span> q;</div><div class="line">      <span class="comment">//否则在左子树上寻找</span></div><div class="line">      <span class="keyword">else</span></div><div class="line">          p = pl;</div><div class="line">  &#125; <span class="keyword">while</span> (p != <span class="keyword">null</span>);</div><div class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* Calls find for root node.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">final</span> TreeNode&lt;K,V&gt; <span class="title">getTreeNode</span><span class="params">(<span class="keyword">int</span> h, Object k)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> ((parent != <span class="keyword">null</span>) ? root() : <span class="keyword">this</span>).find(h, k, <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="HashMap插入元素"><a href="#HashMap插入元素" class="headerlink" title="HashMap插入元素"></a>HashMap插入元素</h3><p>往HashMap中插入一个元素：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//将key和value关联，如果key已经存在，则替换旧值</span></div><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* <span class="doctag">@param</span> onlyIfAbsent if true, don't change existing value</div><div class="line">* <span class="doctag">@param</span> evict if false, the table is in creation mode.</div><div class="line">*/</div><div class="line"><span class="comment">//若是红黑树，调用putTreeVal函数</span></div><div class="line"><span class="comment">//若链表上节点数大于TREEIFY_THRESHOLD，调用treeifyBin函数，resize或者转成红黑树</span></div><div class="line"><span class="comment">//若插入元素大于threshold，则调用resize()函数</span></div><div class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></div><div class="line">              <span class="keyword">boolean</span> evict) &#123;</div><div class="line">   Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</div><div class="line">   <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</div><div class="line">       n = (tab = resize()).length;</div><div class="line">   <span class="comment">//桶为空</span></div><div class="line">   <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</div><div class="line">       tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</div><div class="line">   <span class="keyword">else</span> &#123;</div><div class="line">       Node&lt;K,V&gt; e; K k;</div><div class="line">       <span class="comment">//和桶中第一个元素key相同</span></div><div class="line">       <span class="keyword">if</span> (p.hash == hash &amp;&amp;</div><div class="line">           ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</div><div class="line">           e = p;</div><div class="line">       <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</div><div class="line">           e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</div><div class="line">       <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</div><div class="line">               <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</div><div class="line">                   p.next = newNode(hash, key, value, <span class="keyword">null</span>);</div><div class="line">                   <span class="comment">//当一个链上的节点个数超过8个，则resize或者转成红黑树</span></div><div class="line">                   <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></div><div class="line">                       treeifyBin(tab, hash);</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">if</span> (e.hash == hash &amp;&amp;</div><div class="line">                   ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               p = e;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//有元素key相同</span></div><div class="line">       <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</div><div class="line">           V oldValue = e.value;</div><div class="line">           <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</div><div class="line">               e.value = value;</div><div class="line">           afterNodeAccess(e);</div><div class="line">           <span class="keyword">return</span> oldValue;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   ++modCount;<span class="comment">//增加了一个元素，修改次数+1</span></div><div class="line">   <span class="comment">//元素个数+1，若插入元素大于threshold，则调用resize()函数</span></div><div class="line">   <span class="keyword">if</span> (++size &gt; threshold)</div><div class="line">       resize();</div><div class="line">   afterNodeInsertion(evict);</div><div class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>treeifybin函数实现如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//当一条链上的节点太多时，会触发这个函数，若table比较小，则resize;</span></div><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">treeifyBin</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> hash)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> n, index; Node&lt;K,V&gt; e;</div><div class="line">   <span class="comment">//table为空或table大小小于64，resize</span></div><div class="line">   <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) &lt; MIN_TREEIFY_CAPACITY)</div><div class="line">       resize();</div><div class="line">   <span class="keyword">else</span> <span class="keyword">if</span> ((e = tab[index = (n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</div><div class="line">       TreeNode&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;</div><div class="line">       <span class="keyword">do</span> &#123;</div><div class="line">           TreeNode&lt;K,V&gt; p = replacementTreeNode(e, <span class="keyword">null</span>);</div><div class="line">           <span class="keyword">if</span> (tl == <span class="keyword">null</span>)</div><div class="line">               hd = p;</div><div class="line">           <span class="keyword">else</span> &#123;</div><div class="line">               p.prev = tl;</div><div class="line">               tl.next = p;</div><div class="line">           &#125;</div><div class="line">           tl = p;</div><div class="line">       &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</div><div class="line">       <span class="keyword">if</span> ((tab[index] = hd) != <span class="keyword">null</span>)</div><div class="line">           hd.treeify(tab);<span class="comment">//从链表节点变成红黑树</span></div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>resize函数实现如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//初始化或者double，因为是2倍扩容，元素要不在原来的桶，要不偏移oldCap</span></div><div class="line"><span class="comment">//若是红黑树，调用split函数</span></div><div class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</div><div class="line">   Node&lt;K,V&gt;[] oldTab = table;</div><div class="line">   <span class="keyword">int</span> oldCap = (oldTab == <span class="keyword">null</span>) ? <span class="number">0</span> : oldTab.length;</div><div class="line">   <span class="keyword">int</span> oldThr = threshold;</div><div class="line">   <span class="keyword">int</span> newCap, newThr = <span class="number">0</span>;</div><div class="line">   <span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123;</div><div class="line">       <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</div><div class="line">           threshold = Integer.MAX_VALUE;</div><div class="line">           <span class="keyword">return</span> oldTab;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</div><div class="line">                oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</div><div class="line">           newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></div><div class="line">   &#125;</div><div class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>) <span class="comment">// initial capacity was placed in threshold</span></div><div class="line">       newCap = oldThr;</div><div class="line">   <span class="keyword">else</span> &#123;               <span class="comment">// zero initial threshold signifies using defaults</span></div><div class="line">       newCap = DEFAULT_INITIAL_CAPACITY;</div><div class="line">       newThr = (<span class="keyword">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</div><div class="line">       <span class="keyword">float</span> ft = (<span class="keyword">float</span>)newCap * loadFactor;</div><div class="line">       newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY ?</div><div class="line">                 (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</div><div class="line">   &#125;</div><div class="line">   threshold = newThr;</div><div class="line">   <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>,<span class="string">"unchecked"</span>&#125;)</div><div class="line">       Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[newCap];</div><div class="line">   table = newTab;</div><div class="line">   <span class="keyword">if</span> (oldTab != <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</div><div class="line">           Node&lt;K,V&gt; e;</div><div class="line">           <span class="keyword">if</span> ((e = oldTab[j]) != <span class="keyword">null</span>) &#123;</div><div class="line">               oldTab[j] = <span class="keyword">null</span>;</div><div class="line">               <span class="keyword">if</span> (e.next == <span class="keyword">null</span>)</div><div class="line">                   newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;</div><div class="line">               <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</div><div class="line">                   ((TreeNode&lt;K,V&gt;)e).split(<span class="keyword">this</span>, newTab, j, oldCap);</div><div class="line">               <span class="keyword">else</span> &#123; <span class="comment">// preserve order</span></div><div class="line">                   <span class="comment">//还在原来的下标</span></div><div class="line">                   Node&lt;K,V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</div><div class="line">                   <span class="comment">//下标偏移oldCap</span></div><div class="line">                   Node&lt;K,V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</div><div class="line">                   Node&lt;K,V&gt; next;</div><div class="line">                   <span class="keyword">do</span> &#123;</div><div class="line">                       next = e.next;</div><div class="line">                       <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</div><div class="line">                           <span class="keyword">if</span> (loTail == <span class="keyword">null</span>)</div><div class="line">                               loHead = e;</div><div class="line">                           <span class="keyword">else</span></div><div class="line">                               loTail.next = e;</div><div class="line">                           loTail = e;</div><div class="line">                       &#125;</div><div class="line">                       <span class="keyword">else</span> &#123;</div><div class="line">                           <span class="keyword">if</span> (hiTail == <span class="keyword">null</span>)</div><div class="line">                               hiHead = e;</div><div class="line">                           <span class="keyword">else</span></div><div class="line">                               hiTail.next = e;</div><div class="line">                           hiTail = e;</div><div class="line">                       &#125;</div><div class="line">                   &#125; <span class="keyword">while</span> ((e = next) != <span class="keyword">null</span>);</div><div class="line">                   <span class="keyword">if</span> (loTail != <span class="keyword">null</span>) &#123;</div><div class="line">                       loTail.next = <span class="keyword">null</span>;</div><div class="line">                       newTab[j] = loHead;</div><div class="line">                   &#125;</div><div class="line">                   <span class="keyword">if</span> (hiTail != <span class="keyword">null</span>) &#123;</div><div class="line">                       hiTail.next = <span class="keyword">null</span>;</div><div class="line">                       newTab[j + oldCap] = hiHead;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> newTab;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>对数组下标的理解如下：</strong><br>因为数组大小都是2的幂，例如原来数组大小为8（0000 1000），扩容后则为16（0001 0000）<br>则一个元素对应桶的下标为e.hash &amp; (cap - 1)<br>扩容前下标：e.hash &amp; 0000 0111<br>扩容后下标：e.hash &amp; 0000 1111<br>所以，(e.hash &amp; 0000 1000) == 0 的元素，从右往左数，第4位必为0，所以e.hash &amp; 0000 1111的结果和e.hash &amp; 0000 0111的结果相同，只体现了最后3位，所以元素还在原来的桶里。<br>(e.hash &amp; 0000 1000) != 0 的元素，从右往左数，第4位必为1，所以e.hash &amp; 0000 1111的结果是e.hash &amp; 0000 0111的结果加上8，所以元素下标偏移oldCap。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-05-12</span><i class="fa fa-tag"></i><a href="/categories/Java/" title="Java" class="tag">Java </a><a href="/tags/java/" title="java" class="tag">java </a><a href="/tags/HashMap/" title="HashMap" class="tag">HashMap </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://yoursite.com/2017/05/12/HashMap源码理解/,杏仁的博客,HashMap源码理解,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2017/05/13/SynchronizedMap源码理解/" title="SynchronizedMap源码理解" class="btn">上一篇</a></li><li class="next pagbuttons"><a role="navigation" href="/2017/05/07/LinkedBlockingQueue源码理解/" title="LinkedBlockingQueue源码理解" class="btn">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>